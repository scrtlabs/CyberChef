version: '3'
services:
  cyberchef:
    image: "mpepping/cyberchef:latest@sha256:1772a04fd261f971da89cf6212147afe55a37b4a93421db928a78e01de3d65ea" 
    restart: always
    networks:
      - traefik
    labels:
      - traefik.enable=true
      - traefik.http.routers.cyberchef.rule=Host(`$DOMAIN_NAME`)
      - traefik.http.routers.cyberchef.entrypoints=websecure
      - traefik.http.routers.cyberchef.tls=true
      - traefik.http.services.cyberchef.loadbalancer.server.port=8000
    # Optional: If you need persistent storage for logs, config, etc.
    # volumes:
    #   - "cyberchef-nginx:/etc/nginx"
    #   - "cyberchef-ssl:/etc/ssl"
    #   - "cyberchef-logs:/var/log/nginx"
    # Optional: Define volumes if used above
    # volumes:
    #   cyberchef-nginx:
    #   cyberchef-ssl:
    #   cyberchef-logs:
  traefik:
    image: traefik:v2.10
    command:
      - --api.insecure=false
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --entrypoints.websecure.http.tls.options=default@file
      - --providers.file.directory=/etc/traefik/dynamic
      - --providers.file.watch=true
    ports:
      - 80:80
      - 443:443
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /mnt/secure/cert:/certs:ro
    networks:
      - traefik
    configs:
      - source: tls_config
        target: /etc/traefik/dynamic/tls.yml
networks:
  traefik:
    driver: bridge
configs:
  tls_config:
    content: |-
      tls:
        certificates:
          - certFile: /certs/secret_vm_fullchain.pem
            keyFile: /certs/secret_vm_private.pem
        stores:
          default:
            defaultCertificate:
              certFile: /certs/secret_vm_fullchain.pem
              keyFile: /certs/secret_vm_private.pem
